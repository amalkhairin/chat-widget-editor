<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Widget Editor</title>
    <!-- bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.css" />
    <!-- external css -->
    <link rel="stylesheet" href="./config/css/main.css">
    <link rel="stylesheet" href="./config/css/main.style.css">
    <link rel="stylesheet" href="./config/css/style.css">
</head>
<body style="overflow: hidden;">
    <div id="loading-screen" style="width: 100vw; height: 100vh; position: absolute; background: #00000090; z-index: 99;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);" class="row row-cols-1 my-auto justify-content-center align-items-center">
            <div class="col-auto">
                <div class="square-circle-5"></div>
            </div>
            <div class="col mt-4 text-center">
                <span class="text-center text-white">Memperbarui data...</span> <br>
                <span class="text-white">Jangan khawatir, ini tidak seperti menunggu doi selesai makeup</span>
            </div>
        </div>
    </div>

    <section id="section-navbar">
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
            <div class="container-fluid px-4">
                <div class="navbar-brand">Chat Widget Editor v3.0 <span style="font-size: 10px; color: #979797;">by Maruマル</span></div>
                <div class="d-flex justify-content-end">
                    <div class="ms-auto">
                        <div class="row">
                            <div class="col-auto">
                                <div class="rounded-1 px-2 py-1 d-flex align-items-center" style="color: #8e8e8e; border: 1px solid #484848;">
                                    <span class="me-2">Background</span>
                                    <div class="color-picker">
                                        <input type="color" class="custom-input-color" id="editor-bg-color" value="#ffffff" title="Background">
                                    </div>
                                </div>
                            </div>
                            <div class="col-auto px-1">
                                <button id="btn-generate" class="btn btn-primary shadow-none pb-2" data-bs-placement="bottom" title="Generate CSS" data-bs-toggle="modal" data-bs-target="#myModal">
                                    <svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 640 512"><style>svg{fill:#ffffff}</style><path d="M392.8 1.2c-17-4.9-34.7 5-39.6 22l-128 448c-4.9 17 5 34.7 22 39.6s34.7-5 39.6-22l128-448c4.9-17-5-34.7-22-39.6zm80.6 120.1c-12.5 12.5-12.5 32.8 0 45.3L562.7 256l-89.4 89.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l112-112c12.5-12.5 12.5-32.8 0-45.3l-112-112c-12.5-12.5-32.8-12.5-45.3 0zm-306.7 0c-12.5-12.5-32.8-12.5-45.3 0l-112 112c-12.5 12.5-12.5 32.8 0 45.3l112 112c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256l89.4-89.4c12.5-12.5 12.5-32.8 0-45.3z"/></svg>
                                </button>
                            </div>
                            <div class="col-auto px-1">
                                <button id="btn-reset" class="btn btn-danger shadow-none pb-2" data-bs-placement="bottom" title="Reset CSS">
                                    <svg xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 512 512"><style>svg{fill:#ffffff}</style><path d="M48.5 224H40c-13.3 0-24-10.7-24-24V72c0-9.7 5.8-18.5 14.8-22.2s19.3-1.7 26.2 5.2L98.6 96.6c87.6-86.5 228.7-86.2 315.8 1c87.5 87.5 87.5 229.3 0 316.8s-229.3 87.5-316.8 0c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0c62.5 62.5 163.8 62.5 226.3 0s62.5-163.8 0-226.3c-62.2-62.2-162.7-62.5-225.3-1L185 183c6.9 6.9 8.9 17.2 5.2 26.2s-12.5 14.8-22.2 14.8H48.5z"/></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </nav>
    </section>

    <section id="main">
        <div class="row m-0 align-items-start">
            <!-- toolbar -->
            <div id="toolbar" class="col-md-3 border">
                <div class="mt-3 accordion accordion-flush" id="toolbar-item">
                </div>
            </div>
            <!-- end toolbar -->
            <!-- widget -->
            <div id="widget-container" class="col-md-9">
                <yt-live-chat-item-list-renderer id="widget-wrapper" class="p-5 mt-3" allow-scroll style="overflow: scroll;"></yt-live-chat-item-list-renderer>
            </div>
            <!-- end widget -->
        </div>
    </section>


    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content bg-dark" style="border-radius: 3px !important;">
                <div class="modal-header border border-0">
                    <h6 class="modal-title text-white" id="myModalLabel">Custom CSS</h6>
                    <div class="row row-cols-1 justify-content-end ms-auto me-1">
                        <div class="col-auto">
                            <button id="btn-copy" class="btn btn-primary text-end shadow-none">Copy</button>
                            <button type="button" class="btn btn-outline-danger" data-bs-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
                        </div>
                    </div>
                </div>
                <div class="modal-body">
                    <div class="card shadow-none" style="max-height: 75vh; overflow: none; border: none; background: transparent;">
                        <div class="card-body m-0">
                            <textarea style="border: none; background: transparent !important; color: aquamarine !important;" class="form-control" id="spawner" rows="15" readonly></textarea>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="./config/js/utilities.js"></script>
    <script src="./config/data/css.js"></script>
    <script>

        // replace 'test' with unique identifier for each project
        var uniqueId = 'test'

        var fields = {};

        var docStyle = document.documentElement.style;
        var docStyleGetter = getComputedStyle(document.documentElement, null);

        var editorBGColor = "--editor-bg-color";

        $("#content-app").hide();
        $("#loading-screen").show();

        // on window load
        window.onload = function() {
            // fields = await getJsonData('./config/data/field.json');

            loadWidgetStyle()

            generateMenu(fields);

            addEventTrigger(fields, uniqueId);

            $("#widget-wrapper").empty();
            showChat("#widget-wrapper");

            loadData("#editor-bg-color", editorBGColor, uniqueId);
            loadWidgetData(fields, uniqueId)

            onEventShow(fields);

            $("#loading-screen").hide()
        }

        $(document).ready(function(){
            // fields = await getJsonData('./config/data/field.json');
            // addEventTrigger(fields, 'test');

            loadWidgetStyle()

            $("#editor-bg-color").on('change', function(){
                docStyle.setProperty(editorBGColor, $(this).val());
                localStorage.setItem('test'+editorBGColor, $(this).val());
            })

            $("#btn-reset").on("click", function(){
                localStorage.clear();
                console.log('reset');
                window.location.reload();
            })

            $("#btn-generate").on("click", function(){
                templateStyle = styleChat;
                document.getElementById("spawner").value = templateStyle;
            });

            $("#btn-copy").on("click", function(){
                var copyText = document.getElementById("spawner");
                copyText.select();
                copyText.setSelectionRange(0, 99999);
                window.getSelection().removeAllRanges();
                navigator.clipboard.writeText(copyText.value).then(() => {
                    $(this).html('Copied');
                    setTimeout(function () {
                        $("#btn-copy").html('Copy');
                    }, 2000);
                });
                
            });

        })

        function loadWidgetStyle(){
            let ownerStyle = getStyle(styleChat, "/* owner */","/* end-owner */");
            let moderatorStyle = getStyle(styleChat, "/* moderator */","/* end-moderator */");
            let memberStyle = getStyle(styleChat, "/* member */","/* end-member */");
            let generalStyle = getStyle(styleChat, "/* general */","/* end-general */");
            let membershipStyle = getStyle(styleChat, "/* membership */","/* end-membership */");
            let scStyle = getStyle(styleChat, "/* sc */","/* end-sc */");
            let chatFontSizeStyle = getStyle(styleChat, "/* chat-font-size */","/* end-chat-font-size */");
            let scFontSizeStyle = getStyle(styleChat, "/* sc-font-size */","/* end-sc-font-size */");
            let membershipFontSizeStyle = getStyle(styleChat, "/* membership-font-size */","/* end-membership-font-size */");

            generateStyleData(chatFontSizeStyle, "Chat Settings", "none", "number")
            generateStyleData(ownerStyle, "Chat Settings", "Streamer", "colorPicker")
            generateStyleData(moderatorStyle, "Chat Settings", "Moderator", "colorPicker")
            generateStyleData(memberStyle, "Chat Settings", "Member", "colorPicker")
            generateStyleData(generalStyle, "Chat Settings", "General", "colorPicker")

            generateStyleData(membershipFontSizeStyle, "Membership Settings", "none", "number")
            generateStyleData(membershipStyle, "Membership Settings", "none", "colorPicker")
            
            generateStyleData(scFontSizeStyle, "Superchat Settings", "none", "number")
            generateStyleData(scStyle, "Superchat Settings", "none", "colorPicker")
        }

        function getStyle(styleChat, start, end) {
            // Mencari awal dan akhir komentar /* @start */ dan /* @end*/
            let startIndex = styleChat.indexOf(start);
            let endIndex = styleChat.indexOf(end);
            let cssVariables = [];

            if (startIndex !== -1 && endIndex !== -1) {
                // Mengambil teks CSS antara komentar /* @change */ dan /* @end-change */
                var cssBetweenComments = styleChat.substring(startIndex, endIndex + end.length);

                // Memecah teks CSS menjadi baris-baris
                var cssLines = cssBetweenComments.split('\n');

                // Iterasi melalui setiap baris CSS
                for (var i = 0; i < cssLines.length; i++) {
                    var line = cssLines[i].trim();

                    // Memeriksa apakah baris CSS adalah definisi variabel
                    if (line.startsWith("--")) {
                    // Memecah baris CSS menjadi nama variabel dan nilainya
                    var parts = line.split(":");
                    if (parts.length === 2) {
                        var variableName = parts[0].trim();
                        var variableValue = parts[1].trim();

                        // Menambahkan variabel ke objek cssVariables
                        cssVariables.push(variableName);
                    }
                    }
                }
            }
            return cssVariables;
        }

        function generateStyleData(styles, group, subgroup, type) {
            $.each(styles, function(i, style){
                let key = style.replace('--','')
                key = key.replaceAll('-',' ')
                key = toCamelCase(key)

                fields[key] = {}

                fields[key]["id"] = style.replace('--','')
                fields[key]["css"] = style
                fields[key]["type"] = type
                fields[key]["label"] = capitalizeEachWord(style.replace('--','').replace('owner','').replace('moderator','').replace('membership','').replace('member','').replace('sc','').replace('general','').replaceAll('-',' ')).replace('Bg','Background')
                fields[key]["group"] = group
                fields[key]["sub-group"] = subgroup
            })
        }


        function toCamelCase(inputText) {
            var modifiedText = inputText.replace(/\s(.)/g, function(match, group1) {
                return group1.toUpperCase();
            }).replace(/\s/g, '');
            
            return modifiedText;
        }

        function capitalizeEachWord(inputText) {
            return inputText
                .split(' ')
                .map(function(word) {
                return word.charAt(0).toUpperCase() + word.slice(1);
                })
                .join(' ');
        }
    </script>
</body>
</html>